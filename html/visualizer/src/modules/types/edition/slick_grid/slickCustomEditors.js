'use strict';define(["lodash","src/util/util","src/util/ui","components/spectrum/spectrum","jquery","jquery-ui/ui/widgets/datepicker"],function(a,b,c){"use strict";function d(){if(this.args.column.validator){var a=this.args.column.validator(this.serializeValue());if(!a.valid)return a}return{valid:!0,msg:null}}function e(){return(""!=this.$input.val()||null!=this.defaultValue)&&this.$input.val()!=this.defaultValue}function f(a,b,c){var d;DataObject.check(a,!0),d=c?{type:c,value:b}:b,this.args.grid.module.model.dataSetChildSync(a,this.args.column.jpath,d)}function g(){return this.$input.val()}function h(a){DataObject.check(a,!0),this.defaultValue=a.getChildSync(this.args.column.jpath),this.defaultValue=this.defaultValue?this.defaultValue.get()||"":"",this.$input.val(this.defaultValue),this.$input[0].defaultValue=this.defaultValue,this.$input.select()}function i(a){this.$input.val(a)}function j(){return this.$input.val()}function k(){var a=this,b=this.args.container;this.initOptions=this.initOptions||{};var c=H(this.args.column.colDef.editorOptions);this.initOptions.textarea?($("<div>").appendTo(this.args.container),this.$input=$("<textarea  class=\"editor-text\" rows=\"10\" cols=\"60\" style=\"z-index:10000; position: relative;\"/>")):(this.$input=$("<input type=\"text\" class=\"editor-text\" />"),c.choices&&this.$input.attr("list","choices")),this.$input.appendTo(this.args.container).after(`<datalist id="choices">${G(c.choices)}</datalist>`).bind("keydown.nav",function(a){(a.keyCode===$.ui.keyCode.LEFT||a.keyCode===$.ui.keyCode.RIGHT)&&a.stopImmediatePropagation()}).focus().select().focusout(function(){a.args.grid.module.view.slick.options.autoEdit?a.args.commitChanges&&a.args.commitChanges("none"):a.args.commitChanges&&a.args.commitChanges("next")})}function l(){this.$input.remove()}function m(){this.$input.focus().select()}function n(){return+this.$input.val()}function o(b,c,d){return c=+c,f.call(this,b,a.isNaN(c)?"NaN":c,d)}function p(){var a=this;this.$input=$("<input type=\"checkbox\" value=\"true\" class=\"editor-checkbox\" hideFocus>"),this.$input.appendTo(this.args.container),this.$input.focus(),this.$input.change(function(){a.args.commitChanges("next")})}function q(a){if(DataObject.check(a,!0),this.defaultValue=a.getChildSync(this.args.column.jpath),this.defaultValue)var b=this.defaultValue=this.defaultValue.get();b?b instanceof DataBoolean&&!b.get()?this.$input.removeAttr("checked"):this.$input.attr("checked","checked"):this.$input.removeAttr("checked")}function r(){return!!this.$input[0].checked}function s(){return this.serializeValue()!==this.defaultValue}function t(a,b,c){b="false"!==b&&!!b,f.call(this,a,b,c)}function u(){var a=this;this.$container=$("body"),this.$wrapper=$("<DIV style=\"z-index:10000; position:absolute;background:white; padding:5px;border:3px solid gray; -moz-border-radius:10px; border-radius:10px;\"/>").appendTo(this.$container),this.$input=$("<textarea hidefocus rows=5 style=\"backround:white; width:250px; height:80px;border:0; outline:0\">").appendTo(this.$wrapper),$("<div style=\"text-align:right\"><button>Save</button><button>Cancel</button></div>").appendTo(this.$wrapper),this.$wrapper.find("button:first").bind("click",this.save),this.$wrapper.find("button:last").bind("click",this.cancel),this.$input.bind("keydown",function(b){b.which==$.ui.keyCode.ENTER&&b.ctrlKey?a.save():b.which==$.ui.keyCode.ESCAPE?(b.preventDefault(),a.cancel()):b.which==$.ui.keyCode.TAB&&b.shiftKey?(b.preventDefault(),a.args.grid.navigatePrev()):b.which==$.ui.keyCode.TAB&&(b.preventDefault(),a.args.grid.navigateNext())}),this.position(this.args.position),this.$input.focus().select().focusout(function(){a.args.grid.module.view.slick.options.autoEdit||a.args.commitChanges("next")})}function v(){this.args.commitChanges()}function w(){this.$input.val(this.defaultValue),this.args.cancelChanges()}function x(){this.$wrapper.hide()}function y(){this.$wrapper.show()}function z(a){this.$wrapper.css("top",a.top-5).css("left",a.left-5)}function A(){this.$wrapper.remove()}function B(){this.$wrapper.show(),this.position(this.args.position),this.$input.focus()}function C(a){this.args=a,this.init=u,this.destroy=A,this.focus=B,this.getValue=j,this.setValue=i,this.loadValue=h,this.serializeValue=g,this.applyValue=function(a,b){f.call(this,a,b,this.args.column.dataType)},this.isValueChanged=e,this.validate=d,this.hide=x,this.show=y,this.position=z,this.save=v.bind(this),this.cancel=w.bind(this),this.init()}function D(a){this.args=a,this.initOptions={textarea:!0},this.init=k,this.destroy=l,this.focus=m,this.getValue=j,this.setValue=i,this.loadValue=h,this.serializeValue=g,this.isValueChanged=e,this.validate=d,this.applyValue=function(a,b){f.call(this,a,b,this.args.column.dataType)},this.init()}function E(){var a=this.args.column.colDef.editorOptions,b=H(a),c=$(this.args.container);this.initOptions=this.initOptions||{},this.$input=$(`<select>${G(b.choices)}</select>`),this.$input.appendTo(c).focus().on("change",()=>{this.args.commitChanges("next")}).on("blur",()=>{this.args.cancelChanges()}).focusout(()=>{this.args.grid.module.view.slick.options.autoEdit?this.args.commitChanges("none"):this.args.commitChanges("next")})}function F(a,b){this.args=a,this.initOptions=b,this.init=E,this.destroy=l,this.focus=m,this.getValue=j,this.setValue=i,this.loadValue=h,this.serializeValue=g,this.isValueChanged=e,this.validate=d,this.applyValue=function(a,b){f.call(this,a,b,this.args.column.dataType)},this.init()}function G(a){return a=a?a.split(";").map(a=>a.split(":")):[],a.map(a=>`<option value="${a[0]}">${a[1]||a[0]}</option>`).join("")}function H(a){const c=b.evalOptions(a);return a&&void 0===c?{choices:a}:c||{}}b.loadCss("./components/spectrum/spectrum.css"),function(a){function u(a,b){this.args=a,this.initOptions=b,this.init=k,this.destroy=l,this.focus=m,this.getValue=j,this.setValue=i,this.loadValue=h,this.serializeValue=g,this.isValueChanged=e,this.validate=d,this.applyValue=function(a,b){f.call(this,a,b,this.args.column.dataType)},this.init()}function v(a,b){this.args=a,this.initOptions=b,this.init=k,this.destroy=l,this.focus=m,this.getValue=j,this.setValue=i,this.loadValue=function(a){DataObject.check(a,!0);const b=a.getChildSync(this.args.column.jpath);if(this.item=b,this.defaultValue="",b){const a=b.unit+"";let c=v.mathjs.unit(a);c.value=+b.SI,this.defaultValue=`${c.toNumber(a)} ${a}`}this.$input.val(this.defaultValue),this.$input[0].defaultValue=this.defaultValue,this.$input.select()},this.serializeValue=function(){let a=this.$input.val();if(a)try{const b=H(this.args.column.colDef.editorOptions),c=+a;Number.isNaN(c)||(this.item&&this.item.unit?a=`${a} ${this.item.unit}`:b.base&&(a=`${a} ${b.base}`));const d=v.mathjs.unit(v.mathjs.eval(a));if(b.base){const a=v.mathjs.unit(b.base);if(!a.equalBase(d))throw new Error(`${d.formatUnits()} is not the same base as ${b.base}`)}return{unit:d.formatUnits(),SI:d.value}}catch(a){return c.showNotification(a.message,"warning"),null}},this.isValueChanged=()=>null!==this.serializeValue(),this.validate=d,this.applyValue=function(a,b){f.call(this,a,b,this.args.column.dataType)},this.init()}a.extend(!0,window,{Slick:{CustomEditors:{TextValue:u,NumberValue:function(a){this.args=a,this.init=k,this.destroy=l,this.focus=m,this.getValue=n,this.setValue=i,this.loadValue=h,this.serializeValue=g,this.isValueChanged=e,this.validate=d,this.applyValue=function(a,b){o.call(this,a,b,this.args.column.dataType)},this.init()},BooleanValue:function(a){this.args=a,this.init=p,this.destroy=l,this.focus=m,this.getValue=n,this.setValue=i,this.loadValue=q,this.serializeValue=r,this.isValueChanged=s,this.validate=d,this.applyValue=function(a,b){t.call(this,a,b,this.args.column.dataType)},this.init()},ColorValue:function(b){this.args=b;var c;this.init=function(){var c=this;this.$input=a("<input type=\"text\">");var d=b.container.getBoundingClientRect();this.$div=a("<div>").css({position:"fixed",left:d.left,top:d.top}),a("body").append(this.$div),this.$input.appendTo(this.$div).bind("keydown.nav",function(b){(b.keyCode===a.ui.keyCode.LEFT||b.keyCode===a.ui.keyCode.RIGHT)&&b.stopImmediatePropagation()}).focus().select(),this.$input.spectrum({color:b.item&&b.item.getChildSync&&b.item.getChildSync(b.column.jpath)?b.item.getChildSync(b.column.jpath).get():void 0,appendTo:"body",showInitial:!0,showInput:!0,clickoutFiresChange:!1,showAlpha:!0,showPalette:!0,showSelectionPalette:!0,palette:[["rgba(152,  0,  0, 1)","rgba(255,  0,  0, 1)","rgba(255,  153,  0, 1)","rgba(255,  255,  0, 1)","rgba(0,  255,  0, 1)","rgba(0,  255,  255, 1)","rgba(74,  134,  232, 1)","rgba(0,  0,  255, 1)","rgba(153,  0,  255, 1)","rgba(255,  0,  255, 1)"],["rgba(230,  184,  175, 1)","rgba(244,  204,  204, 1)","rgba(252,  229,  205, 1)","rgba(255,  242,  204, 1)","rgba(217,  234,  211, 1)","rgba(208,  224,  227, 1)","rgba(201,  218,  248, 1)","rgba(207,  226,  243, 1)","rgba(217,  210,  233, 1)","rgba(234,  209,  220, 1)"],["rgba(221,  126,  107, 1)","rgba(234,  153,  153, 1)","rgba(249,  203,  156, 1)","rgba(255,  229,  153, 1)","rgba(182,  215,  168, 1)","rgba(162,  196,  201, 1)","rgba(164,  194,  244, 1)","rgba(159,  197,  232, 1)","rgba(180,  167,  214, 1)","rgba(213,  166,  189, 1)"],["rgba(204,  65,  37, 1)","rgba(224,  102,  102, 1)","rgba(246,  178,  107, 1)","rgba(255,  217,  102, 1)","rgba(147,  196,  125, 1)","rgba(118,  165,  175, 1)","rgba(109,  158,  235, 1)","rgba(111,  168,  220, 1)","rgba(142,  124,  195, 1)","rgba(194,  123,  160, 1)"],["rgba(166,  28,  0, 1)","rgba(204,  0,  0, 1)","rgba(230,  145,  56, 1)","rgba(241,  194,  50, 1)","rgba(106,  168,  79, 1)","rgba(69,  129,  142, 1)","rgba(60,  120,  216, 1)","rgba(61,  133,  198, 1)","rgba(103,  78,  167, 1)","rgba(166,  77,  121, 1)"],["rgba(133,  32,  12, 1)","rgba(153,  0,  0, 1)","rgba(180,  95,  6, 1)","rgba(191,  144,  0, 1)","rgba(56,  118,  29, 1)","rgba(19,  79,  92, 1)","rgba(17,  85,  204, 1)","rgba(11,  83,  148, 1)","rgba(53,  28,  117, 1)","rgba(116,  27,  71, 1)"],["rgba(91,  15,  0, 1)","rgba(102,  0,  0, 1)","rgba(120,  63,  4, 1)","rgba(127,  96,  0, 1)","rgba(39,  78,  19, 1)","rgba(12,  52,  61, 1)","rgba(28,  69,  135, 1)","rgba(7,  55,  99, 1)","rgba(32,  18,  77, 1)","rgba(76,  17,  48, 1)"]],preferredFormat:"rgba",change:function(a){c.color=a,c.changed=!0,b.commitChanges("next")},move:function(){},show:function(){},hide:function(){c.changed||b.cancelChanges()},localStorageKey:"visualizer-spectrum"}),this.$input.next().first().click()},this.destroy=function(){this.$input.data();this.$input.spectrum("destroy"),this.$div.remove()},this.focus=function(){this.$input.focus()},this.getValue=function(){this.$input.val()},this.setValue=function(a){this.$input.val(a)},this.loadValue=function(a){DataObject.check(a,!0),c=a.getChildSync(b.column.jpath),c=c?c.get()+""||"#000000":"#000000",this.$input.val(c),this.$input.spectrum("set",c),this.$input[0].defaultValue=c,this.$input.select()},this.serializeValue=function(){return this.color?this.color.toRgbString():this.$input.val()},this.applyValue=function(a,b){f.call(this,a,b,this.args.column.dataType)},this.isValueChanged=function(){return(""!=this.$input.val()||null!=c)&&this.$input.val()!=c},this.validate=function(){if(b.column.validator){var a=b.column.validator(this.$input.val());if(!a.valid)return a}return{valid:!0,msg:null}},this.init()},Text:u,Date:function(b){this.args=b;var c,d,e=!1;this.init=function(){c=a("<INPUT type=\"text\" class=\"editor-text\" />"),c.appendTo(b.container),c.focus().select(),c.datepicker({showOn:"button",buttonImageOnly:!0,buttonImage:require.toUrl("components/slickgrid/images/calendar.gif"),beforeShow:function(){e=!0},onClose:function(){e=!1}}),c.width(c.width()-18)},this.destroy=function(){a.datepicker.dpDiv.stop(!0,!0),c.datepicker("hide"),c.datepicker("destroy"),c.remove()},this.show=function(){e&&a.datepicker.dpDiv.stop(!0,!0).show()},this.hide=function(){e&&a.datepicker.dpDiv.stop(!0,!0).hide()},this.position=function(b){e&&a.datepicker.dpDiv.css("top",b.top+30).css("left",b.left)},this.focus=function(){c.focus()},this.loadValue=function(a){DataObject.check(a,!0),d=a.getChildSync(b.column.jpath),d=d?d.value||"01/01/2000":"01/01/2000",c.val(d),c[0].defaultValue=d,c.select()},this.serializeValue=function(){return c.val()},this.applyValue=function(a,b){f.call(this,a,b,this.args.column.dataType)},this.isValueChanged=function(){return(""!=c.val()||null!=d)&&c.val()!=d},this.validate=function(){return{valid:!0,msg:null}},this.init()},LongText:C,SimpleLongText:D,Select:F,Unit:v}}}),v.load=async function(){const a=await b.require("mathjs");v.mathjs=a}}(jQuery)});
