!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.JcampConverter=t():e.JcampConverter=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function r(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(a,n,function(t){return e[t]}.bind(null,n));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";function a(){const e=/[, \t]+/,t=["TIC",".RIC","SCANNUMBER"];function r(e){var t=[];for(let r=0;r<e.length;r++)t.push(parseFloat(e[r]));return t}class a{}const n={keepRecordsRegExp:/^$/,xy:!1,withoutXY:!1,chromatogram:!1,keepSpectra:!1,noContour:!1,nbContourLevels:7,noiseMultiplier:5,profiling:!1};function i(e){return e.toLowerCase().replace(/[^a-z0-9]/g,"")}function s(e){return-1!==t.indexOf(e)}function o(e,t){if(t.xFactor||(t.xFactor=1),t.yFactor||(t.yFactor=1),t.observeFrequency&&t.xUnit&&"HZ"===t.xUnit.toUpperCase()&&(t.xUnit="PPM",t.xFactor=t.xFactor/t.observeFrequency,t.firstX=t.firstX/t.observeFrequency,t.lastX=t.lastX/t.observeFrequency,t.deltaX=t.deltaX/t.observeFrequency),t.shiftOffsetVal){var r=t.firstX-t.shiftOffsetVal;t.firstX=t.firstX-r,t.lastX=t.lastX-r}}function l(e,t){return e-t}function f(e,t){var r=e.yFactor,a=e.deltaX;e.isXYdata=!0;var n=[];e.data=[n];var i,s=e.firstX,o=e.firstY,l=!1;let f=0;for(;f<t.length;f++)if(13===(i=t.charCodeAt(f))||10===i)l=!0;else if(l)break;for(var p=!0,u=!1,c=!1,h=0,g=!1,d=!1,m=0,v=0,y=!1,F=!1,x=!1,A=0;f<=t.length;f++)if(i=f===t.length?13:t.charCodeAt(f),d)13!==i&&10!==i||(p=!0,d=!1);else if(i<=57&&i>=48)F=!0,A>0?m+=(i-48)/Math.pow(10,A++):(m*=10,m+=i-48);else if(44===i||46===i)F=!0,A++;else{if(F){if(p)p=!1,c&&(x=!0);else if(x)x=!1;else{u?(h=y?0-m:m,c=!0,u=!1):g||(v=y?0-m:m);for(var b=g?m-1:1,X=0;X<b;X++)c?o+=h:o=v,n.push(s),n.push(o*r),s+=a}y=!1,m=0,A=0,F=!1,g=!1}if(i<74&&i>63)F=!0,c=!1,m=i-64;else if(i>96&&i<106)F=!0,c=!1,m=i-96,y=!0;else if(115===i)F=!0,g=!0,m=9;else if(i>82&&i<91)F=!0,g=!0,m=i-82;else if(i>73&&i<83)F=!0,u=!0,m=i-73;else if(i>105&&i<115)F=!0,u=!0,m=i-105,y=!0;else if(36===i&&36===t.charCodeAt(f+1))F=!0,d=!0;else if(37===i)F=!0,u=!0,m=0,y=!1;else if(45===i){var T=t.charCodeAt(f+1);(T>=48&&T<=57||44===T||46===T)&&(F=!0,p||(c=!1),y=!0)}else 13!==i&&10!==i||(p=!0,d=!1)}}function p(e,t){var r,a=/(\(+|\)+|<+|>+|\s+)/g;e.isXYAdata=!0;var n=[];e.data=[n];var i=t.split(/,? *,?[;\r\n]+ */);for(let e=1;e<i.length;e++)r=i[e].trim().replace(a,"").split(","),n.push(parseFloat(r[0])),n.push(parseFloat(r[1]))}function u(e,t,r){var a,n=/\$\$.*/,i=/[,\t ]+/;e.isPeaktable=!0;var s=[];e.data=[s];var o=t.split(/,? *,?[;\r\n]+ */);for(let t=1;t<o.length;t++)if((a=o[t].trim().replace(n,"").split(i)).length%2==0)for(let t=0;t<a.length;t+=2)s.push(parseFloat(a[t])*e.xFactor),s.push(parseFloat(a[t+1])*e.yFactor);else r.logs.push("Format error: ".concat(a))}return function(c,h){var g,d,m,v,y,F,x,A=!(h=Object.assign({},n,h)).withoutXY,b=Date.now(),X={},T={};T.profiling=!!h.profiling&&[],T.logs=[];var O=[];T.spectra=O,T.info={};var E=new a;if("string"!=typeof c)throw new TypeError("the JCAMP should be a string");T.profiling&&T.profiling.push({action:"Before split to LDRS",time:Date.now()-b}),v=c.split(/[\r\n]+##/),T.profiling&&T.profiling.push({action:"Split to LDRS",time:Date.now()-b}),v[0]&&(v[0]=v[0].replace(/^[\r\n ]*##/,""));for(let t=0;t<v.length;t++){if((y=(g=v[t]).indexOf("="))>0?(d=g.substring(0,y),m=g.substring(y+1).trim()):(d=g,m=""),"DATATABLE"===(d=d.replace(/[_ -]/g,"").toUpperCase())&&(-1===(F=m.indexOf("\n"))&&(F=m.indexOf("\r")),F>0)){var S=-1,M=-1;if((x=m.substring(0,F).split(/[ ,;\t]+/))[0].indexOf("++")>0){var w=x[0].replace(/.*\(([a-zA-Z0-9]+)\+\+.*/,"$1"),Y=x[0].replace(/.*\.\.([a-zA-Z0-9]+).*/,"$1");S=X.symbol.indexOf(w),M=X.symbol.indexOf(Y)}-1===S&&(S=0),-1===M&&(M=0),X.first&&(X.first.length>S&&(E.firstX=X.first[S]),X.first.length>M&&(E.firstY=X.first[M])),X.last&&(X.last.length>S&&(E.lastX=X.last[S]),X.last.length>M&&(E.lastY=X.last[M])),X.vardim&&X.vardim.length>S&&(E.nbPoints=X.vardim[S]),X.factor&&(X.factor.length>S&&(E.xFactor=X.factor[S]),X.factor.length>M&&(E.yFactor=X.factor[M])),X.units&&(X.units.length>S&&(E.xUnit=X.units[S]),X.units.length>M&&(E.yUnit=X.units[M])),E.datatable=x[0],x[1]&&x[1].indexOf("PEAKS")>-1?d="PEAKTABLE":x[1]&&(x[1].indexOf("XYDATA")||x[0].indexOf("++")>0)&&(d="XYDATA",E.deltaX=(E.lastX-E.firstX)/(E.nbPoints-1))}if("XYDATA"!==d)if("PEAKTABLE"!==d)if("PEAKASSIGNMENTS"!==d){if("TITLE"===d)E.title=m;else if("DATATYPE"===d)E.dataType=m,m.indexOf("nD")>-1&&(T.twoD=!0);else if("NTUPLES"===d)m.indexOf("nD")>-1&&(T.twoD=!0);else if("XUNITS"===d)E.xUnit=m;else if("YUNITS"===d)E.yUnit=m;else if("FIRSTX"===d)E.firstX=parseFloat(m);else if("LASTX"===d)E.lastX=parseFloat(m);else if("FIRSTY"===d)E.firstY=parseFloat(m);else if("LASTY"===d)E.lastY=parseFloat(m);else if("NPOINTS"===d)E.nbPoints=parseFloat(m);else if("XFACTOR"===d)E.xFactor=parseFloat(m);else if("YFACTOR"===d)E.yFactor=parseFloat(m);else if("MAXX"===d)E.maxX=parseFloat(m);else if("MINX"===d)E.minX=parseFloat(m);else if("MAXY"===d)E.maxY=parseFloat(m);else if("MINY"===d)E.minY=parseFloat(m);else if("DELTAX"===d)E.deltaX=parseFloat(m);else if(".OBSERVEFREQUENCY"===d||"$SFO1"===d)E.observeFrequency||(E.observeFrequency=parseFloat(m));else if(".OBSERVENUCLEUS"===d)E.xType||(T.xType=m.replace(/[^a-zA-Z0-9]/g,""));else if("$SFO2"===d)T.indirectFrequency||(T.indirectFrequency=parseFloat(m));else if("$OFFSET"===d)T.shiftOffsetNum=0,E.shiftOffsetVal||(E.shiftOffsetVal=parseFloat(m));else if("$REFERENCEPOINT"===d);else if("VARNAME"===d)X.varname=m.split(e);else if("SYMBOL"===d)X.symbol=m.split(e);else if("VARTYPE"===d)X.vartype=m.split(e);else if("VARFORM"===d)X.varform=m.split(e);else if("VARDIM"===d)X.vardim=r(m.split(e));else if("UNITS"===d)X.units=m.split(e);else if("FACTOR"===d)X.factor=r(m.split(e));else if("FIRST"===d)X.first=r(m.split(e));else if("LAST"===d)X.last=r(m.split(e));else if("MIN"===d)X.min=r(m.split(e));else if("MAX"===d)X.max=r(m.split(e));else if(".NUCLEUS"===d)T.twoD&&(T.yType=m.split(e)[0]);else if("PAGE"===d){E.page=m.trim(),E.pageValue=parseFloat(m.replace(/^.*=/,"")),E.pageSymbol=E.page.replace(/[=].*/,"");var P=X.symbol.indexOf(E.pageSymbol),C="";X.units&&X.units[P]&&(C=X.units[P]),T.indirectFrequency&&"PPM"!==C&&(E.pageValue/=T.indirectFrequency)}else"RETENTIONTIME"===d?E.pageValue=parseFloat(m):s(d)?E[i(d)]=m:"SAMPLEDESCRIPTION"===d&&(E.sampleDescription=m);d.match(h.keepRecordsRegExp)&&(T.info[d]?(Array.isArray(T.info[d])||(T.info[d]=[T.info[d]]),T.info[d].push(m.trim())):T.info[d]=m.trim())}else A&&(m.match(/.*(XYA).*/)&&p(E,m),O.push(E),E=new a);else A&&(o(0,E),u(E,m,T),O.push(E),E=new a);else A&&(o(0,E),m.match(/.*\+\+.*/)?(E.deltaX||(E.deltaX=(E.lastX-E.firstX)/(E.nbPoints-1)),f(E,m)):u(E,m,T),O.push(E),E=new a)}if(T.profiling&&T.profiling.push({action:"Finished parsing",time:Date.now()-b}),Object.keys(X).length>0){var N=[],R=Object.keys(X);for(let e=0;e<R.length;e++){var D=R[e],L=X[D];for(let e=0;e<L.length;e++)N[e]||(N[e]={}),N[e][D]=L[e]}T.ntuples=N}if(T.twoD&&A&&(function(e,t){var r=function(e){var t=e[0].data[0][0],r=t,a=e.length,n=e[0].data[0].length/2,i=new Array(a);for(let l=0;l<a;l++){i[l]=new Array(n);var s=e[l].data[0];for(let e=0;e<n;e++){var o=s[2*e+1];i[l][e]=o,o<t&&(t=o),o>r&&(r=o)}}const f=e[0].data[0][0],p=e[0].data[0][e[0].data[0].length-2],u=e[0].pageValue,c=e[a-1].pageValue;if(f>p)for(let e of i)e.reverse();return u>c&&i.reverse(),{z:i,minX:Math.min(f,p),maxX:Math.max(f,p),minY:Math.min(u,c),maxY:Math.max(u,c),minZ:t,maxZ:r,noise:(h=i[0].map(Math.abs),g=(h=h.sort(l)).length,h[Math.floor(g/2)])};var h,g}(e.spectra);t.noContour||(e.contourLines=function(e,t){for(var r,a,n,i,s,o,l,f,p,u,c,h,g,d=e.noise,m=e.z,v=m.length,y=m[0].length,F=e.minX,x=(e.maxX-F)/(y-1),A=e.minY,b=(e.maxY-A)/(v-1),X=e.minZ,T=e.maxZ,O=2*t.nbContourLevels,E=new Array(O),S=0;S<O;S++){var M={};E[S]=M;var w=S%2,Y=(T-t.noiseMultiplier*d)*Math.exp((S>>1)-t.nbContourLevels);g=0===w?Y+t.noiseMultiplier*d:0-Y-t.noiseMultiplier*d;var P=[];if(M.zValue=g,M.lines=P,!(g<=X||g>=T))for(var C=0;C<v-1;C++)for(var N=m[C],R=m[C+1],D=0;D<y-1;D++)r=N[D],a=N[D+1],n=R[D],i=R[D+1],l=n>g,f=i>g,(s=r>g)!=(o=a>g)&&s!==l&&(p=D+(g-r)/(a-r),u=C,c=D,h=C+(g-r)/(n-r),P.push(p*x+F),P.push(u*b+A),P.push(c*x+F),P.push(h*b+A)),f!==o&&f!==l&&(p=D+1,u=C+1-(g-i)/(a-i),c=D+1-(g-i)/(n-i),h=C+1,P.push(p*x+F),P.push(u*b+A),P.push(c*x+F),P.push(h*b+A)),o!==l&&(p=(D+1-(g-a)/(n-a))*x+F,u=(C+(g-a)/(n-a))*b+A,o!==s&&(c=D+1-(g-a)/(r-a),h=C,P.push(p),P.push(u),P.push(c*x+F),P.push(h*b+A)),l!==s&&(c=D,h=C+1-(g-n)/(r-n),P.push(p),P.push(u),P.push(c*x+F),P.push(h*b+A)),o!==f&&(c=D+1,h=C+(g-a)/(i-a),P.push(p),P.push(u),P.push(c*x+F),P.push(h*b+A)),l!==f&&(c=D+(g-n)/(i-n),h=C+1,P.push(p),P.push(u),P.push(c*x+F),P.push(h*b+A)))}return{minX:e.minX,maxX:e.maxX,minY:e.minY,maxY:e.maxY,segments:E}}(r,t),delete r.z),e.minMax=r}(T,h),T.profiling&&T.profiling.push({action:"Finished countour plot calculation",time:Date.now()-b}),h.keepSpectra||delete T.spectra),h.chromatogram&&(h.xy=!0),h.xy&&A&&O.length>0)for(let e=0;e<O.length;e++)if((E=O[e]).data.length>0)for(let e=0;e<E.data.length;e++){for(var U=E.data[e],j={x:new Array(U.length/2),y:new Array(U.length/2)},I=0;I<U.length;I+=2)j.x[I/2]=U[I],j.y[I/2]=U[I+1];E.data[e]=j}return h.chromatogram&&(T.spectra.length>1?function(e){var r=e.spectra,a=r.length,n={times:new Array(a),series:{ms:{dimension:2,data:new Array(a)}}},s=[];for(let e=0;e<t.length;e++){var o=i(t[e]);r[0][o]&&(s.push(o),n.series[o]={dimension:1,data:new Array(a)})}for(let e=0;e<a;e++){var l=r[e];n.times[e]=l.pageValue;for(let t=0;t<s.length;t++)n.series[s[t]].data[e]=parseFloat(l[s[t]]);l.data&&(n.series.ms.data[e]=[l.data[0].x,l.data[0].y])}e.chromatogram=n}(T):function(e){var t=e.spectra[0].data[0];e.chromatogram={times:t.x.slice(),series:{intensity:{dimension:1,data:t.y.slice()}}}}(T),T.profiling&&T.profiling.push({action:"Finished chromatogram calculation",time:Date.now()-b})),T.profiling&&T.profiling.push({action:"Total time",time:Date.now()-b}),T}}var n=a();var i,s={};e.exports={convert:function(e,t,r){return"boolean"==typeof t&&(r=t,t={}),r?function(e,t){var r;return i||(r=URL.createObjectURL(new Blob(["var getConverter =".concat(a.toString(),";var convert = getConverter(); onmessage = function (event) { var data = JSON.parse(event.data); postMessage(JSON.stringify({stamp: data.stamp, output: convert(data.input, data.options)})); };")],{type:"application/javascript"})),i=new Worker(r),URL.revokeObjectURL(r),i.addEventListener("message",function(e){var t=JSON.parse(e.data),r=t.stamp;s[r]&&s[r](t.output)})),new Promise(function(r){var a="".concat(Date.now()).concat(Math.random());s[a]=r,i.postMessage(JSON.stringify({stamp:a,input:e,options:t}))})}(e,t):n(e,t)},createTree:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{flatten:r=!1}=t;if("string"!=typeof e)throw new TypeError("the JCAMP should be a string");let a,n=e.split(/[\r\n]+/),i=[],s=[],o=[],l=0,f=e.includes("## ");for(var p=0;p<n.length;p++){let e=n[p],t=f?e.replace(/ /g,""):e;if("##NTUPLES"===t.substring(0,9)&&l++,"##TITLE"===t.substring(0,7)){let r=[t.substring(8).trim()];for(let e=p+1;e<n.length&&!n[e].startsWith("##");e++)r.push(n[e].trim());s.push({title:r.join("\n"),jcamp:"".concat(e,"\n"),children:[]}),a=s[s.length-1],i.push(a)}else if("##END"===t.substring(0,5)&&0===l){a.jcamp+="".concat(e,"\n");var u=s.pop();0!==s.length?(a=s[s.length-1]).children.push(u):(a=void 0,o.push(u))}else if(a&&a.jcamp){a.jcamp+="".concat(e,"\n");var c=t.match(/^##(.*?)=(.+)/);c&&"DATATYPE"===c[1].replace(/[ _-]/g,"").toUpperCase()&&(a.dataType=c[2].trim())}"##END"===t.substring(0,5)&&l>0&&l--}return r?(i.forEach(e=>{e.children=void 0}),i):o}}}])});